---
title: 3. インデックス方法と検索設定を指定
---

コンテンツの分割モードを選択した後、構造化されたコンテンツの**インデックス方法**と**検索設定**を行います。

## インデックス方法の設定

検索エンジンが効率的なインデックスアルゴリズムを通じてユーザーの質問に最も関連するウェブページコンテンツをマッチングするように、インデックス方法の適切さはLLMがナレッジベース内のコンテンツを検索する効率と回答の正確性に直接影響します。

**高品質**と**エコノミー**の2種類のインデックス方法を提供しており、それぞれ異なる検索設定オプションがあります：

<Note>
  元のQ&Aモード（コミュニティ版のみ対応）は、高品質インデックス方法のオプションになりました。
</Note>

<Tabs>
  <Tab title="高品質">
    **高品質**

    高品質モードでは、Embeddingモデルを使用して、分割されたテキストブロックを数値ベクトルに変換し、大量のテキスト情報をより効果的に圧縮・保存します。**これによりユーザーの質問とテキスト間のマッチングがより正確になります**。

    コンテンツブロックをベクトル化してデータベースに登録した後、ユーザーの質問にマッチするコンテンツブロックを効果的に取り出す検索方法が必要です。高品質モードでは、ベクトル検索、全文検索、ハイブリッド検索の3つの検索設定を提供しています。各設定の詳細については、[検索設定](#検索方法の指定)を参照してください。

    高品質モードを選択した後、現在のナレッジベースのインデックス方法を後から**「エコノミー」インデックスモード**にダウングレードすることはできません。切り替えが必要な場合は、ナレッジベースを新しく作成し、インデックス方法を再選択することをお勧めします。

    > Embedding技術とベクトルについての詳細は、[「Embedding技術とDify」](https://mp.weixin.qq.com/s/vmY_CUmETo2IpEBf1nEGLQ)を参照してください。

    <img
      src="https://assets-docs.dify.ai/2024/12/51442c8fcd05479616a3dd8279a4853a.png"
      className="mx-auto"
      alt="高品質モード"
    />

    **Q\&Aモードの有効化（オプション、[コミュニティ版](/ja-jp/getting-started/install-self-hosted/faq)のみ）**

    このモードを有効にすると、システムはアップロードされたテキストを分割し、各分割のコンテンツを要約して自動的にQ\&Aマッチングペアを生成します。一般的な「Q to P」（ユーザーの質問がテキスト段落にマッチング）戦略とは異なり、QAモードでは「Q to Q」（質問が質問にマッチング）戦略を採用しています。

    これは「よくある質問」文書内のテキストが**通常、完全な文法構造を持つ自然言語**であるため、Q to Qモードによって質問と回答のマッチングがより明確になり、同時に高頻度で類似度の高い質問のシナリオにも対応できるからです。

    > **Q\&Aモードは「中国語、英語、日本語」の3言語のみサポートしています。このモードを有効にするとより多くのLLM Tokensを消費する可能性があり、**[**エコノミーインデックス方法**](/ja-jp/guides/knowledge-base/create-knowledge-and-upload-documents/setting-indexing-methods)**は使用できません。**

    <img
      src="https://assets-docs.dify.ai/2024/12/70960a237d4f5eaed2dbf46a2cca2bf7.png"
      className="mx-auto"
      alt="Q\&A チャンキング"
    />

    ユーザーが質問すると、システムは最も類似した質問を見つけ、対応する分割を回答として返します。この方法はより精密で、ユーザーの質問に直接マッチングするため、ユーザーが本当に必要とする情報をより正確に検索できます。

    <img
      src="https://assets-docs.dify.ai/2024/12/8745ccabff56290eae329a9d3592f745.png"
      className="mx-auto"
      alt="Q to P と Q to Q のインデックスモードの違い"
    />
  </Tab>
  <Tab title="エコノミー">
    **エコノミー**

    エコノミーモードでは、各ブロック内で10個のキーワードを使用して検索し、精度は下がりますが費用は発生しません。検索されたブロックに対しては、逆引きインデックス方式のみで最も関連性の高いブロックを選択します。詳細は[以下](#検索方法の指定)をお読みください。

    エコノミータイプのインデックス方法を選択した後、実際の効果が良くないと感じる場合は、ナレッジベース設定ページで**「高品質」インデックス方法**にアップグレードできます。

    <img
      src="https://assets-docs.dify.ai/2024/12/3b86e6b484da39452c164cb6372a7242.png"
      className="mx-auto"
      alt="エコノミーモード"
    />
  </Tab>
</Tabs>

## 検索方法の指定 <a href="#retrieval_settings" id="retrieval_settings"></a>

ナレッジベースはユーザーのクエリを受け取った後、事前設定された検索方法に従って既存の文書内で関連コンテンツを検索し、言語モデルが高品質な回答を生成するために高度に関連する情報の断片を抽出します。これはLLMが取得できる背景情報を決定し、生成結果の正確性と信頼性に影響を与えます。

一般的な検索方法には、ベクトル類似度に基づく意味検索と、キーワードに基づく精密マッチングがあります。前者はテキストコンテンツブロックと質問クエリをベクトルに変換し、ベクトル類似度の計算によってより深いレベルの意味的関連性をマッチングします。後者は検索エンジンでよく使われる検索方法である逆引きインデックスを通じて、質問と重要なコンテンツをマッチングします。

異なるインデックス方法には異なる検索設定があります。

<Tabs>
  <Tab title="高品質インデックス">
    **高品質インデックス**

    高品質インデックス方法では、Difyはベクトル検索、全文検索、ハイブリッド検索の設定を提供しています：

    <img
      src="https://assets-docs.dify.ai/2024/12/9b02fc353324221cc91f185a350775b6.png"
      className="mx-auto"
      alt="検索設定"
    />

    **ベクトル検索**

    **定義：** ユーザーが入力した質問をベクトル化し、クエリテキストの数学ベクトルを生成し、クエリベクトルとナレッジベース内の対応するテキストベクトル間の距離を比較し、隣接する分割コンテンツを探します。

    <img
      src="https://assets-docs.dify.ai/2024/12/620044faa47a5037f85b32a27a56fce5.png"
      className="mx-auto"
      alt="ベクトル検索"
    />

    **ベクトル検索設定：**

    **Rerankモデル：** デフォルトでは無効です。有効にすると、ベクトル検索によって呼び出されたコンテンツセグメントを第三者のRerankモデルを使用して再度並べ替え、並べ替え結果を最適化します。LLMがより正確なコンテンツを取得し、出力の品質を向上させるのを助けます。このオプションを有効にする前に、「設定」→「モデルプロバイダー」に移動し、RerankモデルのAPIキーを事前に設定する必要があります。

    > この機能を有効にすると、Rerankモデルのトークンが消費されます。詳細については、対応するモデルの価格説明を参照してください。

    **TopK：** ユーザーの質問との類似度が最も高いテキスト断片をフィルタリングするために使用されます。システムは同時に使用するモデルのコンテキストウィンドウサイズに基づいて断片の数を動的に調整します。デフォルト値は3です。値が高いほど、呼び出されるテキストセグメントの予想数が多くなります。

    **Scoreしきい値：** テキスト断片をフィルタリングする類似度のしきい値を設定するために使用され、設定されたスコアを超えるテキスト断片のみを呼び出します。デフォルト値は0.5です。値が高いほど、テキストと質問の類似度の要求が高くなり、呼び出されるテキストの予想数も少なくなります。

    > TopKとScore設定はRerankステップでのみ有効であるため、RerankモデルをRerankモデルを追加して有効にする必要があります。

    ***

    **全文検索**

    **定義：** キーワード検索、つまり文書内のすべての語彙のインデックス作成です。ユーザーが質問を入力した後、明示的なキーワードによってナレッジベース内の対応するテキスト断片をマッチングし、キーワードに合致するテキスト断片を返します。検索エンジンの明示的な検索と類似しています。

    <img
      src="https://assets-docs.dify.ai/2024/12/513bff1ca38ec746b3246502b0311b39.png"
      className="mx-auto"
      alt="全文検索"
    />

    **Rerankモデル：** デフォルトでは無効です。有効にすると、全文検索によって呼び出されたコンテンツセグメントを第三者のRerankモデルを使用して再度並べ替え、並べ替え結果を最適化します。LLMに再並べ替えされたセグメントを送信し、出力コンテンツの品質を向上させます。このオプションを有効にする前に、「設定」→「モデルプロバイダー」に移動し、RerankモデルのAPIキーを事前に設定する必要があります。

    > この機能を有効にすると、Rerankモデルのトークンが消費されます。詳細については、対応するモデルの価格説明を参照してください。

    **TopK：** ユーザーの質問との類似度が最も高いテキスト断片をフィルタリングするために使用されます。システムは同時に使用するモデルのコンテキストウィンドウサイズに基づいて断片の数を動的に調整します。システムのデフォルト値は3です。値が高いほど、呼び出されるテキストセグメントの予想数が多くなります。

    **Scoreしきい値：** テキスト断片をフィルタリングする類似度のしきい値を設定するために使用され、設定されたスコアを超えるテキスト断片のみを呼び出します。デフォルト値は0.5です。値が高いほど、テキストと質問の類似度の要求が高くなり、呼び出されるテキストの予想数も少なくなります。

    > TopKとScore設定はRerankステップでのみ有効であるため、RerankモデルをRerankモデルを追加して有効にする必要があります。

    ***

    **ハイブリッド検索**

    **定義：** 全文検索とベクトル検索、またはRerankモデルを同時に実行し、クエリ結果からユーザーの質問に最もマッチする最良の結果を選択します。

    <img
      src="https://assets-docs.dify.ai/2024/12/bd2621bfe8a1a8e21fca0743ec495a9e.png"
      className="mx-auto"
      alt="ハイブリッド検索"
    />

    ハイブリッド検索設定では、**「重み付け設定」**または**「Rerankモデル」**の有効化を選択できます。

    *   **重み付け設定**

        ユーザーが意味的優先度とキーワード優先度にカスタム重みを付けることができます。キーワード検索はナレッジベース内での全文検索（Full Text Search）を指し、意味検索はナレッジベース内でのベクトル検索（Vector Search）を指します。

        *   **意味値を1にする**

            **意味検索モードのみを有効にします**。Embeddingモデルを活用することで、クエリに含まれる正確な単語がナレッジベースになくても、ベクトル距離を計算することで検索の深度を高め、正確なコンテンツを返すことができます。また、多言語コンテンツを処理する必要がある場合、意味検索は異なる言語間の意味変換をキャプチャし、より正確なクロス言語検索結果を提供できます。
        *   **キーワード値を1にする**

            **キーワード検索モードのみを有効にします**。ユーザーが入力した情報テキストをナレッジベース全体でマッチングし、ユーザーが正確な情報や用語を知っているシナリオに適しています。この方法は消費する計算リソースが比較的少なく、大量の文書を含むナレッジベース内での迅速な検索に適しています。
        *   **キーワードと意味の重みをカスタマイズする**

            異なる値を1に引き上げるだけでなく、両者の重みを継続的に調整して、ビジネスシナリオに合った最適な重み比率を見つけることができます。

    > 意味検索とは、ユーザーの質問とナレッジベースコンテンツ内のベクトル間の距離を比較することを指します。距離が近いほど、マッチングの確率が高くなります。参考文献：[「Dify：Embedding技術とDifyナレッジベースの設計/計画」](https://mp.weixin.qq.com/s/vmY_CUmETo2IpEBf1nEGLQ)。

    ***

    *   **Rerankモデル**

        デフォルトでは無効です。有効にすると、ハイブリッド検索によって呼び出されたコンテンツセグメントを第三者のRerankモデルを使用して再度並べ替え、並べ替え結果を最適化します。LLMに再並べ替えされたセグメントを送信し、出力コンテンツの品質を向上させます。このオプションを有効にする前に、「設定」→「モデルプロバイダー」に移動し、RerankモデルのAPIキーを事前に設定する必要があります。

        > この機能を有効にすると、Rerankモデルのトークンが消費されます。詳細については、対応するモデルの価格説明を参照してください。

    **「重み付け設定」**と**「Rerankモデル」**設定では、以下のオプションを有効にすることができます：

    **TopK：** ユーザーの質問との類似度が最も高いテキスト断片をフィルタリングするために使用されます。システムは同時に使用するモデルのコンテキストウィンドウサイズに基づいて断片の数を動的に調整します。システムのデフォルト値は3です。値が高いほど、呼び出されるテキストセグメントの予想数が多くなります。

    **Scoreしきい値：** テキスト断片をフィルタリングする類似度のしきい値を設定するために使用されます。つまり、設定されたスコアを超えるテキスト断片のみを呼び出します。システムはデフォルトでこの設定を無効にしています。つまり、呼び出されたテキスト断片の類似値をフィルタリングしません。有効にするとデフォルト値は0.5です。値が高いほど、呼び出されるテキストの予想数は少なくなります。
  </Tab>
  <Tab title="エコノミーインデックス">
    **逆引きインデックス**

    エコノミーインデックス方法では、**逆引きインデックス方式**のみが提供されます。これは文書内のキーワードを迅速に検索するためのインデックス構造で、オンライン検索エンジンでよく使用されています。逆引きインデックスは**TopK**設定項目のみをサポートしています。

    **TopK：**

    ユーザーの質問との類似度が最も高いテキスト断片をフィルタリングするために使用されます。システムは同時に使用するモデルのコンテキストウィンドウサイズに基づいて断片の数を動的に調整します。システムのデフォルト値は3です。値が高いほど、呼び出されるテキストセグメントの予想数が多くなります。

    <img
      src="https://assets-docs.dify.ai/2024/12/b417cd028131d34779993fbcbb8dbdd7.png"
      className="mx-auto"
      alt="逆引きインデックス"
    />
  </Tab>
</Tabs>

## もっと読む

検索設定を指定した後、以下のドキュメントを参照して、実際のシナリオでのキーワードとコンテンツブロックのマッチング状況を確認できます。

<Card title="リコールテスト/引用と帰属" icon="link" href="../retrieval-test-and-citation">
  実際のシナリオでのキーワードとコンテンツブロックのマッチング状況を確認する
</Card>

{/*
Contributing Section
DO NOT edit this section!
It will be automatically generated by the script.
*/}

<CardGroup cols="2">
    <Card
        title="このページを編集する"
        icon="pen-to-square"
        href="https://github.com/langgenius/dify-docs/edit/main/ja-jp/guides/knowledge-base/create-knowledge-and-upload-documents/setting-indexing-methods.mdx"
    >
        直接貢献することでドキュメントの改善にご協力ください
    </Card>
    <Card
        title="問題を報告する"
        icon="github"
        href="https://github.com/langgenius/dify-docs/issues/new?title=ドキュメントの問題%3A%20ng-indexing-meth&body=%23%23%20問題の説明%0A%3C%21--%20発見した問題について簡単に説明してください%20--%3E%0A%0A%23%23%20ページリンク%0Ahttps%3A%2F%2Fgithub.com%2Flanggenius%2Fdify-docs%2Fblob%2Fmain%2Fja-jp/guides/knowledge-base/create-knowledge-and-upload-documents%2Fsetting-indexing-methods.mdx%0A%0A%23%23%20提案される変更%0A%3C%21--%20特定の変更案がある場合は、ここで説明してください%20--%3E%0A%0A%3C%21--%20ドキュメントの品質向上にご協力いただきありがとうございます！%20--%3E"
    >
        エラーを見つけたり提案がありますか？お知らせください
    </Card>
</CardGroup>
